@page "/workoutplan/{WorkoutPlanId}"
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>@(workoutPlan?.Name ?? "Loading Workout Plan...")</PageTitle>

<MudItem xs="12">
    <MudText Typo="Typo.h4" Align="Align.Center">
        Workout Plan: @workoutPlan?.Name
    </MudText>
</MudItem>

<MudItem xs="12">
    @if (_items == null || _items.Count == 0)
    {
        <MudText Typo="Typo.h5" Class="pa-4" Align="Align.Center">
            No exercises found. You can add exercises to your plan on the <MudLink Typo="Typo.h5" Color="Color.Primary" Href="/exercises">exercises page</MudLink>.
        </MudText>
    }
    else
    {
        <MudDivider />
    }
</MudItem>

<MudItem xs="12">
    <MudStack Row>
        <MudButton Color="Color.Primary" Variant="Variant.Outlined" Disabled="@(_weekNumber <= 1)" OnClick="() => _weekNumber--">
            Previous
        </MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Outlined" Disabled="@(_weekNumber >= 12)" OnClick="() => _weekNumber++">
            Next
        </MudButton>
        <MudSpacer />
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveChanges">Save</MudButton>
    </MudStack>
    <MudText Align="Align.Center" Typo="Typo.h5" Class="mx-4">
        Week @_weekNumber
    </MudText>
</MudItem>
<MudHidden Breakpoint="Breakpoint.MdAndDown" Invert>
    <MudItem xs="12" md="5">
        <MudCard>
            <MudExpansionPanel Style="font-weight: 500;" Text=@($"Your Exercises ({_items.GroupBy(i => i.ExerciseId).Count()})")>
                @foreach (var item in _items.GroupBy(i => i.ExerciseId).Select(g => g.First()))
                {
                    <MudListItem>
                        <MudText Class="py-2" Align="Align.Center">@item.Name</MudText>
                            <MudStack Row Justify="Justify.SpaceBetween">
                             <MudButton Size="Size.Small" Href=@($"/exercise/{item.ExerciseId}") Color="Color.Primary" Variant="Variant.Text">Details</MudButton>
                             <MudButton Size="Size.Small" Color="Color.Error" Variant="Variant.Text" OnClick="@(() => RemoveExercise(item))">Remove</MudButton>
                         </MudStack>
                     </MudListItem>
                    <MudDivider />
                }
            </MudExpansionPanel>
        </MudCard>
    </MudItem>
    <MudItem xs="12" md="7">
        <MudCard>
            <MudList>
                @foreach (var day in daysOfWeekOrdered)
                {
                    var exercisesForDay = _items.Where(i => i.DayOfWeek == day.ToString() && i.WeekNumber == _weekNumber).ToList();
                    <MudExpansionPanel Style="font-weight: 500;" Text=@($"{day} ({exercisesForDay.Count})")>
                        @foreach (var exercise in exercisesForDay)
                        {
                            <MudListItem>
                                <MudText Class="py-2" Align="Align.Center">@exercise.Name</MudText>
                                    <MudStack Row Justify="Justify.SpaceBetween">
                                     <MudButton Size="Size.Small" Href=@($"/exercise/{exercise.ExerciseId}") Color="Color.Primary" Variant="Variant.Text">Details</MudButton>
                                     <MudIconButton Size="Size.Small" Icon=@Icons.Material.Filled.Clear Color="Color.Error" OnClick="@(() => RemoveInstance(exercise))" />
                                 </MudStack>
                             </MudListItem>
                            <MudDivider />

                        }
                        <MudButton Class="mt-2" FullWidth Color="Color.Primary" Variant="Variant.Text" OnClick="@(() => AddExerciseToDay(day))">
                             Add Exercise
                         </MudButton>

                     </MudExpansionPanel>
                }
            </MudList>
        </MudCard>
    </MudItem>
</MudHidden>
<MudHidden Breakpoint="Breakpoint.LgAndUp" Invert>
    <MudItem xs="12">
        <MudDropContainer T="SavedExercise" Items="_items" ItemsSelector="@((item, dropzone) => (item.WeekNumber == null || item.WeekNumber == _weekNumber) && (dropzone == "Unassigned" ? item.DayOfWeek == null : item.DayOfWeek == dropzone))" ItemDropped="ItemUpdated" Class="d-flex">
            <ChildContent>
                <MudItem xs="5" md="12">
                    <MudDropZone AllowReorder="true" T="SavedExercise" Identifier="Unassigned" Class="rounded mud-background-gray pa-6 ma-8" Style="position: fixed; max-height: 550px; overflow-y: auto;">
                        <MudText Typo="Typo.h6" Class="mb-4">Your Exercises</MudText>
                    </MudDropZone>
                </MudItem>
                <MudItem xs="12">
                    <MudGrid>
                        @foreach (var day in daysOfWeekOrdered)
                        {
                            <MudItem xs="12" Class="pa-0">
                                <MudDropZone AllowReorder="true" T="SavedExercise" Identifier=@day.ToString() Class="rounded mud-background-gray pa-6 ma-8">
                                    <MudText Typo="Typo.h6" Class="mb-4">
                                        @day
                                    </MudText>
                                </MudDropZone>
                            </MudItem>
                        }
                    </MudGrid>
                </MudItem>
            </ChildContent>
            <ItemRenderer>
                <MudCard Class="pa-2 mt-4">
                    <MudStack Justify="Justify.SpaceBetween" Class="flex-wrap">
                        <MudText Typo="Typo.body1" Align="Align.Center">
                            @context.Name
                        </MudText>
                        <MudStack Row Justify="Justify.SpaceBetween">
                             <MudButton Href=@($"/exercise/{context.ExerciseId}") Color="Color.Primary" Variant="Variant.Text">
                                 <MudText Typo="Typo.subtitle2">
                                     Details
                                 </MudText>
                             </MudButton>
                             @if (context.DayOfWeek == null)
                            {
                                <MudButton Color="Color.Error" Variant="Variant.Text" OnClick="@(() => RemoveExercise(context))">
                                    <MudText Typo="Typo.subtitle2">
                                        Remove
                                    </MudText>
                                </MudButton>
                            }
                            else
                            {
                                <MudIconButton Icon=@Icons.Material.Filled.Clear Color="Color.Error" OnClick="@(() => RemoveInstance(context))" />
                            }
                        </MudStack>
                    </MudStack>
                </MudCard>
            </ItemRenderer>
        </MudDropContainer>
    </MudItem>
</MudHidden>
@code {
    [Parameter] public string? WorkoutPlanId { get; set; }
    private WorkoutPlan? workoutPlan;
    private int _weekNumber = 1;
    private List<SavedExercise> _items = new List<SavedExercise>();

    protected override async Task OnInitializedAsync()
    {
        workoutPlan = await Http.GetFromJsonAsync<WorkoutPlan>($"/workoutplan/{WorkoutPlanId}");

        if (workoutPlan?.Exercises != null)
        {
            _items = workoutPlan.Exercises.ToList();
        }
    }

    private async Task RemoveExercise(SavedExercise exercise)
    {
        await Http.DeleteAsync($"/workoutplan/{WorkoutPlanId}/exercise/{exercise.ExerciseId}");
        workoutPlan = await Http.GetFromJsonAsync<WorkoutPlan>($"/workoutplan/{WorkoutPlanId}");

        if (workoutPlan?.Exercises != null)
        {
            _items = workoutPlan.Exercises.ToList();
        }
    }

    private void RemoveInstance(SavedExercise instance)
    {
        _items.RemoveAll(i => i.InstanceId == instance.InstanceId);
        StateHasChanged();
    }

    private void ItemUpdated(MudItemDropInfo<SavedExercise> dropItem)
    {
        if (dropItem.Item != null && dropItem.DropzoneIdentifier != "Unassigned")
        {
            if (dropItem.Item.DayOfWeek == null)
            {
                var newInstance = new SavedExercise
                    {
                        InstanceId = Guid.NewGuid().ToString(),
                        ExerciseId = dropItem.Item.ExerciseId,
                        Name = dropItem.Item.Name,
                        DayOfWeek = Enum.Parse<DayOfWeek>(dropItem.DropzoneIdentifier).ToString(),
                        WeekNumber = _weekNumber,
                        Order = _items.Count(i => i.DayOfWeek == dropItem.DropzoneIdentifier)
                    };

                _items.Add(newInstance);
            }
            else
            {
                dropItem.Item.DayOfWeek = Enum.Parse<DayOfWeek>(dropItem.DropzoneIdentifier).ToString();
            }

            var exercisesInDropzone = _items.Where(i => i.DayOfWeek == dropItem.DropzoneIdentifier).ToList();
            for (int i = 0; i < exercisesInDropzone.Count; i++)
            {
                exercisesInDropzone[i].Order = i;
            }

            _items = _items.OrderBy(i => i.Order).ToList();

            StateHasChanged();
        }
    }
    private async Task SaveChanges()
    {
        var response = await Http.PutAsJsonAsync($"/workoutplan/{WorkoutPlanId}", _items);

        if (response.IsSuccessStatusCode)
        {
            Snackbar.Add("Changes saved successfully.", Severity.Success);
        }
        else
        {
            Snackbar.Add("Failed to save changes. Please try again.", Severity.Error);
        }
    }

    private readonly List<DayOfWeek> daysOfWeekOrdered = new List<DayOfWeek>
    {
        DayOfWeek.Monday,
        DayOfWeek.Tuesday,
        DayOfWeek.Wednesday,
        DayOfWeek.Thursday,
        DayOfWeek.Friday,
        DayOfWeek.Saturday,
        DayOfWeek.Sunday
    };

    private async Task AddExerciseToDay(DayOfWeek day)
    {
        var uniqueExercises = _items.GroupBy(i => i.ExerciseId).Select(g => g.First()).ToList();
        var dialog = DialogService.Show<SelectExerciseDialog>("Select an Exercise", parameters: new DialogParameters { { "Exercises", uniqueExercises } }, options: new DialogOptions { MaxWidth = MaxWidth.Small });
        var result = await dialog.Result;

        if (!result.Cancelled && result.Data is SavedExercise selectedExercise)
        {
            var newInstance = new SavedExercise
                {
                    InstanceId = Guid.NewGuid().ToString(),
                    ExerciseId = selectedExercise.ExerciseId,
                    Name = selectedExercise.Name,
                    DayOfWeek = day.ToString(),
                    WeekNumber = _weekNumber,
                    Order = _items.Count(i => i.DayOfWeek == day.ToString())
                };

            _items.Add(newInstance);
            StateHasChanged();
        }
    }

}